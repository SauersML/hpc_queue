name: E2E Tests

on:
  pull_request:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  static-checks:
    name: Static Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: producer-worker/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Node deps
        run: npm ci
        working-directory: producer-worker

      - name: Typecheck Worker
        run: npm run typecheck
        working-directory: producer-worker

      - name: Python compile checks
        run: |
          python -m py_compile q.py
          python -m py_compile hpc-consumer/hpc_pull_consumer.py
          python -m py_compile laptop-consumer/laptop_pull_results.py
          python -m py_compile containers/app/run.py
          python -m py_compile tests/e2e/enqueue_message.py

      - name: Shell syntax checks
        run: |
          bash -n hpc-consumer/install_user_service.sh
          bash -n hpc-consumer/service_control.sh
          bash -n hpc-consumer/scripts/update_apptainer_image.sh
          bash -n hpc-consumer/start_consumer.sh
          bash -n tests/e2e/cloudflare_e2e.sh
          bash -n tests/e2e/full_e2e_existing_worker.sh

  local-worker-smoke:
    name: Local Worker Smoke
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: producer-worker/package-lock.json

      - name: Install Node deps
        run: npm ci
        working-directory: producer-worker

      - name: Run local worker smoke test
        run: |
          set -euo pipefail
          cd producer-worker
          echo 'API_KEY=ci-local-key' > .dev.vars

          npx wrangler dev --local --port 8787 > "$RUNNER_TEMP/wrangler.log" 2>&1 &
          WRANGLER_PID=$!

          cleanup() {
            kill "$WRANGLER_PID" >/dev/null 2>&1 || true
            rm -f .dev.vars
          }
          trap cleanup EXIT

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8787/health -H 'x-api-key: ci-local-key' >/dev/null; then
              break
            fi
            sleep 1
          done

          HEALTH_JSON="$(curl -fsS http://127.0.0.1:8787/health -H 'x-api-key: ci-local-key')"
          echo "$HEALTH_JSON" | grep -q '"ok":true'

          JOB_JSON="$(curl -fsS -X POST http://127.0.0.1:8787/jobs \
            -H 'content-type: application/json' \
            -H 'x-api-key: ci-local-key' \
            -d '{"task":"smoke","input":{"n":1}}')"

          echo "$JOB_JSON" | grep -q '"status":"queued"'

      - name: Print wrangler log on failure
        if: failure()
        run: cat "$RUNNER_TEMP/wrangler.log"

  cloudflare-e2e:
    name: Cloudflare Queue E2E
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.QUEUE_TOKEN || secrets.HPC_QUEUE_KEY }}
      API_KEY: ${{ secrets.API_KEY }}
      WORKER_URL: "https://hpc-queue-producer.sauer354.workers.dev"
      CLOUDFLARE_ACCOUNT_ID: "59908b351c3a3321ff84dd2d78bf0b42"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: producer-worker/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Node deps
        run: npm ci
        working-directory: producer-worker

      - name: Skip when required secrets are missing
        if: ${{ env.CLOUDFLARE_API_TOKEN == '' || env.API_KEY == '' }}
        run: |
          echo "Missing queue-token (QUEUE_TOKEN/HPC_QUEUE_KEY) or api-key (API_KEY) secret; skipping Cloudflare E2E."
          exit 0

      - name: Run Cloudflare E2E script
        if: ${{ env.CLOUDFLARE_API_TOKEN != '' && env.API_KEY != '' }}
        run: tests/e2e/full_e2e_existing_worker.sh
