name: E2E Tests

on:
  pull_request:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  static-checks:
    name: Static Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: producer-worker/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Node deps
        run: npm ci
        working-directory: producer-worker

      - name: Typecheck Worker
        run: npm run typecheck
        working-directory: producer-worker

      - name: Python compile checks
        run: |
          python -m py_compile hpc-consumer/hpc_pull_consumer.py
          python -m py_compile laptop-consumer/laptop_pull_results.py
          python -m py_compile containers/app/run.py

      - name: Shell syntax checks
        run: |
          bash -n hpc-consumer/install_user_service.sh
          bash -n hpc-consumer/service_control.sh
          bash -n hpc-consumer/scripts/update_apptainer_image.sh

  local-worker-smoke:
    name: Local Worker Smoke
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: producer-worker/package-lock.json

      - name: Install Node deps
        run: npm ci
        working-directory: producer-worker

      - name: Run local worker smoke test
        run: |
          set -euo pipefail
          cd producer-worker
          echo 'API_KEY=ci-local-key' > .dev.vars

          npx wrangler dev --local --port 8787 > "$RUNNER_TEMP/wrangler.log" 2>&1 &
          WRANGLER_PID=$!

          cleanup() {
            kill "$WRANGLER_PID" >/dev/null 2>&1 || true
            rm -f .dev.vars
          }
          trap cleanup EXIT

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8787/health -H 'x-api-key: ci-local-key' >/dev/null; then
              break
            fi
            sleep 1
          done

          HEALTH_JSON="$(curl -fsS http://127.0.0.1:8787/health -H 'x-api-key: ci-local-key')"
          echo "$HEALTH_JSON" | grep -q '"ok":true'

          JOB_JSON="$(curl -fsS -X POST http://127.0.0.1:8787/jobs \
            -H 'content-type: application/json' \
            -H 'x-api-key: ci-local-key' \
            -d '{"task":"smoke","input":{"n":1}}')"

          echo "$JOB_JSON" | grep -q '"status":"queued"'

      - name: Print wrangler log on failure
        if: failure()
        run: cat "$RUNNER_TEMP/wrangler.log"

  cloudflare-e2e:
    name: Cloudflare Queue E2E
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.HPC_QUEUE_KEY }}
      CLOUDFLARE_ACCOUNT_ID: "59908b351c3a3321ff84dd2d78bf0b42"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: producer-worker/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Node deps
        run: npm ci
        working-directory: producer-worker

      - name: Create temp queues and attach HTTP pull consumers
        id: queues
        run: |
          set -euo pipefail
          cd producer-worker

          JOBS_QUEUE="ci-jobs-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          RESULTS_QUEUE="ci-results-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"

          npx wrangler queues create "$JOBS_QUEUE"
          npx wrangler queues create "$RESULTS_QUEUE"

          for i in {1..10}; do
            npx wrangler queues consumer http add "$JOBS_QUEUE" && break
            sleep 2
          done

          for i in {1..10}; do
            npx wrangler queues consumer http add "$RESULTS_QUEUE" && break
            sleep 2
          done

          JOBS_QUEUE_ID="$(npx wrangler queues info "$JOBS_QUEUE" | awk -F': ' '/Queue ID:/ {print $2}')"
          RESULTS_QUEUE_ID="$(npx wrangler queues info "$RESULTS_QUEUE" | awk -F': ' '/Queue ID:/ {print $2}')"

          echo "jobs_queue=$JOBS_QUEUE" >> "$GITHUB_OUTPUT"
          echo "results_queue=$RESULTS_QUEUE" >> "$GITHUB_OUTPUT"
          echo "jobs_queue_id=$JOBS_QUEUE_ID" >> "$GITHUB_OUTPUT"
          echo "results_queue_id=$RESULTS_QUEUE_ID" >> "$GITHUB_OUTPUT"

      - name: Enqueue CI job message
        env:
          JOBS_QUEUE_ID: ${{ steps.queues.outputs.jobs_queue_id }}
        run: |
          set -euo pipefail
          JOB_ID="ci-e2e-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "JOB_ID=$JOB_ID" >> "$GITHUB_ENV"
          RESP="$(curl -fsS -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/queues/${JOBS_QUEUE_ID}/messages" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "{\"body\":{\"job_id\":\"${JOB_ID}\",\"task\":\"ci-e2e\",\"input\":{\"iterations\":3,\"source\":\"github-actions\"}}}")"
          echo "$RESP" | grep -q '"success":true'

      - name: Run HPC consumer once (direct mode)
        env:
          CF_JOBS_QUEUE_ID: ${{ steps.queues.outputs.jobs_queue_id }}
          CF_RESULTS_QUEUE_ID: ${{ steps.queues.outputs.results_queue_id }}
          CF_QUEUES_API_TOKEN: ${{ secrets.HPC_QUEUE_KEY }}
          APPTAINER_BIN: /bin/echo
          APPTAINER_IMAGE: ci-dummy-image
          RESULTS_DIR: ${{ runner.temp }}/results
          POLL_INTERVAL_SECONDS: "1"
          PYTHONUNBUFFERED: "1"
        run: |
          set -euo pipefail
          python hpc-consumer/hpc_pull_consumer.py > "$RUNNER_TEMP/hpc.log" 2>&1 &
          PID=$!
          sleep 8
          kill "$PID" >/dev/null 2>&1 || true
          cat "$RUNNER_TEMP/hpc.log"

      - name: Pull result events and verify job id
        env:
          CF_RESULTS_QUEUE_ID: ${{ steps.queues.outputs.results_queue_id }}
          CF_QUEUES_API_TOKEN: ${{ secrets.HPC_QUEUE_KEY }}
          RESULTS_POLL_INTERVAL_SECONDS: "1"
          PYTHONUNBUFFERED: "1"
        run: |
          set -euo pipefail
          python laptop-consumer/laptop_pull_results.py > "$RUNNER_TEMP/laptop.log" 2>&1 &
          PID=$!
          sleep 8
          kill "$PID" >/dev/null 2>&1 || true

          cat "$RUNNER_TEMP/laptop.log"

          grep -q "$JOB_ID" "$RUNNER_TEMP/laptop.log"
          test -f "$RUNNER_TEMP/results/$JOB_ID/output.json"

      - name: Cleanup temp queues
        if: always()
        env:
          JOBS_QUEUE: ${{ steps.queues.outputs.jobs_queue }}
          RESULTS_QUEUE: ${{ steps.queues.outputs.results_queue }}
        run: |
          set +e
          cd producer-worker
          if [ -n "${JOBS_QUEUE:-}" ]; then
            npx wrangler queues delete "$JOBS_QUEUE" --force
          fi
          if [ -n "${RESULTS_QUEUE:-}" ]; then
            npx wrangler queues delete "$RESULTS_QUEUE" --force
          fi
